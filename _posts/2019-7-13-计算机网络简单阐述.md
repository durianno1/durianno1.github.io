---
layout: post
title: '计算机网络相关简单记录'
subtitle: '网络模型、TCP/IP协议族，三次握手'
date: 2019-07-13
categories: 技术
cover: 'http://on2171g4d.bkt.clouddn.com/jekyll-theme-h2o-postcover.jpg'
tags:  计算机网络
---
TCP/IP协议总览图
![总览](https://github.com/durianno1/durianno1.github.io/blob/master/assets/img/tcp1.png?raw=true)
以http请求为例，浏览器发出一个请求，应用层、传输层、网络层、链路层、物理层分别对请求进行包装，每层的作用都不相同，但都是帮助请求准确的找到他应该去的地方。当接收方收到请求后，再根据协议分别拆包以获得请求内容。

## 应用层
应用层包含很多协议，会根据应用类型来决定使用哪种协议，比如正常的web请求使用HTTP协议，类似购物的web请求，使用加密的HTTPS协议,发送电子邮件时使用SMTP协议,还有域名解析时使用的DNS协议。以HTTP为例，它的报文：
![http报文](https://github.com/durianno1/durianno1.github.io/blob/master/assets/img/tcp2.jpg?raw=true)
在 Resquest Headers 中，Accept 表示客户端期望接收的数据格式，而 ContentType 则表示客户端发送的数据格式；在 Response Headers 中，ContentType 表示服务端响应的数据格式，这里定义的格式，一般是和  Resquest Headers 中 Accept 定义的格式是一致的。有了这个规范以后，服务端收到请求以后，就能正确的解析客户端发来的数据，当请求处理完以后，再按照客户端要求的格式返回，客户端收到结果后，按照服务端返回的格式进行解析。所以**应用层的主要工作就是定义数据格式并按照对应的格式解读数据**。

## 传输层
我们的网络应用在计算机中运行会占用一个个端口，不同的网络应用使用不同的端口发送和接收数据，当计算机收到数据时，我们需要解析传输层协议来得知该数据需要交给哪个端口的应用，在应用层中我们知道了数据格式，那么在传输层中，我们要确定数据处理的端口。传输层协议包括TCP和UDP，这两种协议都能够传输报文，但是有很大的不同。
UDP 协议向它的应用程序提供了无连接服务。它不具备可靠性的特征，没有流量控制，也没有拥塞控制。UDP数据包由首部和数据两部分组成，首部长度为8个字节，主要包括源端口和目标端口；数据最大为65527个字节，整个数据包的长度最大可达到65535个字节。
TCP 简单来说就是有**确认机制的UDP**，并加入了**三次握手 四次挥手**，它能够控制并确认报文是否到达，并提供了拥塞机制来控制网络传输，因此当网络拥塞时，会抑制其传输速率。
总结一下，传输层的主要工作是**定义端口，标识应用程序身份，实现端口到端口的通信，TCP协议可以保证数据传输的可靠性**。

### 三次握手 四次挥手
三次握手的目的在于保证双方的连接无误
1.发送端发送一个带SYN=1（SYN标识=1表示建立连接申请）、seq=x（序列号）的数据包给接收端
2.接收端发送一个带SYN=1（SYN标识=1表示建立连接申请）、ACK=1（ACK标识=1表示接受你的连接）、ack=x+1（来时的seq+1，该字段只有在ACK标识=1时才有效）、seq=y的数据包给发送端。
3.发送端发送一个ACK=1（ACK=1表示接受你的连接）、ack=y+1（来时的seq+1）、seq=x+1
seq序列号为每一个发送的数据标号，ack表示该端希望下次收到数据的seq，以此来确定返回的是否是那次请求的数据

四次挥手
1.发送端发送一个带FIN=1（表示申请结束连接）、seq=x的数据包
2.接受端发送一个ACK=1、ack=x+1、seq=y（没有发送FIN=1因为要等待数据传输完成）的数据包
3.接收端发送一个FIN=1、ACK=1、seq=w、ack=x+1的数据包
4.发送端发送一个ACK=1、seq=u+1、ack=w+1

### 为什么连接的时候是三次握手，关闭的时候却是四次握手？
因为连接时接收端一起同步（SYN）应答（ACK）即可，断开时接收端要先应答（ACK），然后等待传输完数据再同步断开，所以一步分成了两步。

### 为什么不能进行两次握手
因为第三次握手才确定了发送端已经接收到了接受端的同步和应答。


## 网络层
在网络层包装的数据叫IP数据包，IP数据包由首部和数据两部分组成，首部长度为20个字节，主要包含了目标IP地址和源IP地址，目标IP地址是网关路由的线索和依据；数据部分的最大长度为65515字节，理论上一个IP数据包的总长度可以达到65535个字节，而以太网数据包的最大长度是1500个字符，如果超过这个大小，就需要对IP数据包进行分割，分成多帧发送。所以，网络层的主要工作是**定义网络地址，区分网段，子网内MAC寻址，对于不同子网的数据包进行路由**。

## 链路层
网络模型的目的就有意义的数据从一方发送到另一方，链路层将电信号分组并标识，每一组电信号是一个数据包，称为帧，以太网协议制定了一个标准，整个数据帧由首部、数据和尾部三部分组成，首部固定为14个字节，包含了目标MAC地址、源MAC地址和类型；数据最短为46个字节，最长为1500个字节，如果需要传输的数据很长，就必须分割成多个帧进行发送；尾部固定为4个字节，表示数据帧校验序列，用于确定数据包在传输过程中是否损坏。因此，以太网协议通过对电信号进行分组并形成数据帧，然后通过物理介质把数据帧发送给接收方。
计算机通过网卡来发送和接受数据，如果说ip地址是世界网络中的身份证，那MAC可以看作是本地局域网的身份证，因为局域网内可能有多个计算机，有了MAC以后，以太网使用广播将数据发送给每一个子网计算机，子网计算机通过比较首部中的目标MAC，来确定是否接收这个数据.
所以链路层的主要工作就是**对电信号进行分组并形成具有特定意义的数据帧，然后以广播的形式通过物理介质发送给接收方**。

## 物理层
物理介质，物理介质就是把电脑连接起来的物理手段，常见的有光纤、双绞线，以及无线电波，它决定了电信号(0和1)的传输方式，物理介质的不同决定了电信号的传输带宽、速率、传输距离以及抗干扰性等等。

## 流程总结
当输入一个网址并按下回车键的时候，首先，应用层协议对该请求包做了格式定义；紧接着传输层协议加上了双方的端口号，确认了双方通信的应用程序；然后网络协议加上了双方的IP地址，确认了双方的网络位置；最后链路层协议加上了双方的MAC地址，确认了双方的物理位置，同时将数据进行分组，形成数据帧，采用广播方式，通过传输介质发送给对方主机。而对于不同网段，该数据包首先会转发给网关路由器，经过多次转发后，最终被发送到目标主机。目标机接收到数据包后，采用对应的协议，对帧数据进行组装，然后再通过一层一层的协议进行解析，最终被应用层的协议解析并交给服务器处理。




