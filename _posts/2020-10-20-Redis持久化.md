---
layout: post
title: 'redis持久化'
subtitle: 'RDB、AOF'
date: 2020-01-06
categories: 技术
cover: 'http://on2171g4d.bkt.clouddn.com/jekyll-theme-h2o-postcover.jpg'
tags:  redis
---
## RDB持久化 ##

将当前数据库的状态保存为二进制文件，存储在磁盘中。

- 优点：文件小，载入快
- 缺点：定期保存容易受宕机影响丢失数据

### 创建与载入 ###

1. 手动保存

   - SAVE

     SAVE命令会阻塞Redis服务器进程，直到RDB文件创建完毕

   - BGASAVE

     BGSAVE命令会派生一个子进程，Redis服务器可以继续处理请求

2. 自动保存

   通过设置服务器配置的save选项，比如：

   > save 900 1              #900秒之内进行过一次修改
   >
   > save 300 10		    #300秒之内进行过十次修改
   >
   > save 60 10000	   #60秒内进行过一万次修改

3. 载入

   当关闭AOF持久化功能条件下，Redis服务器启动时，若检测到RDB文件，将自动载入，载入时处于阻塞状态。

   

## AOF持久化 ##

AOF是通过保存Redis服务器所执行过的命令，以一个增量形式来记录数据库状态的。所以这方式，会产生冗余命令，这也引出了AOF重写机制。

- 优点：安全性高，针对每次状态变化
- 缺点：AOF文件大，载入慢

### 持久化步骤 ###

1. 命令追加(append)

   当AOF持久化功能打开时，服务器在执行完一个命令之后，会以协议格式将写命令追加到服务器状态的aof_buf缓冲区的末尾

2. 写入与同步

   服务器配置的appendfsync选项可以配置不同的写入与同步方案

   | appendfsync的值 | 执行方案                                                     |
   | --------------- | ------------------------------------------------------------ |
   | always          | 将aof_buf缓冲区中命令写入并同步到AOF文件                     |
   | everysec        | 将aof_buf缓冲区中命令写入到AOF文件，若上次同步至今已超过1秒，则进行同步 |
   | no              | 只写入，同步交给操作系统决定                                 |

   写入：指将aof_buf中命令写入AOF文件缓冲区

   同步：将AOF文件缓冲区中内容写入磁盘



### 载入 ###

创建一个伪客户端，将AOF文件中的命令执行一遍，从而恢复数据库状态。



### 重写 ###

删除造成冗余而不改变数据库状态的命令记录，重写服务将会在子进程中进行，不会阻塞服务器接受命令。子进程拥有主进程的数据副本，可以在不使用锁的前提下保证安全性。

#### 重写缓冲区 ####

但是在子进程重写期间，主进程可能会接受命令，这会导致重写后的AOF与主进程数据库状态不一致。为了解决这种情况，引入了重写缓冲区。

在子进程进行AOF重写期间，服务器进程有以下三个工作：

1. 执行客户端发来的命令
2. 将执行后的命令追加到aof_buf
3. 将执行后的命令追加到AOF重写缓冲区

这样可以保证：

- aof_buf的内容可以如期进行写入和同步，对现有AOF文件处理照常进行。
- 从创建子进程开始，服务器接受的所有命令都会保存在AOF重写缓冲区。

当AOF重写子进程执行结束后，进行：

1. 将AOF重写缓冲区中内容写入到新AOF文件，此时AOF文件状态将与数据库一致。
2. 将新的AOF文件改名，原子性的覆盖旧AOF文件。

以上两步会阻塞主进程。

